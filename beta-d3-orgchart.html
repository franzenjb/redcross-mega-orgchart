<!DOCTYPE html>
<html>
<head>
    <title>Red Cross Org Chart - Beta (D3)</title>
    <meta charset="utf-8">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 24px;
            color: #1a1a1a;
            margin-bottom: 15px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .region-select {
            padding: 8px 15px;
            border: 2px solid #ed1b2e;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #333;
            cursor: pointer;
            min-width: 200px;
        }
        
        .btn {
            padding: 8px 20px;
            background: #ed1b2e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #c41230;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6d6e70;
        }
        
        .btn-secondary:hover {
            background: #5a5b5d;
        }
        
        .search-box {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 250px;
            font-size: 14px;
        }
        
        #chart-container {
            width: 100%;
            height: calc(100vh - 120px);
            background: white;
            overflow: hidden;
        }
        
        /* D3 OrgChart Custom Styles */
        .node-rect {
            rx: 5;
            ry: 5;
            fill: white;
            stroke: #ddd;
            stroke-width: 2;
        }
        
        .node-rect-executive {
            fill: #ed1b2e;
            stroke: #c41230;
        }
        
        .node-rect-chief {
            fill: #fff5f5;
            stroke: #ed1b2e;
        }
        
        .node-rect-director {
            fill: #f8f9fa;
            stroke: #6d6e70;
        }
        
        .node-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .node-title {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .node-location {
            font-size: 11px;
            opacity: 0.6;
        }
        
        .link {
            fill: none;
            stroke: #aaa;
            stroke-width: 1.5;
        }
        
        /* Legend */
        .legend {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        
        /* Loading */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ed1b2e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè• Red Cross SE & Caribbean Division - Beta Org Chart (D3)</h1>
        <div class="controls">
            <select class="region-select" id="regionSelect">
                <option value="all">All Regions</option>
                <option value="alabama-mississippi">Alabama/Mississippi</option>
                <option value="florida-nc">Florida N/C</option>
                <option value="florida-south">Florida South</option>
                <option value="georgia">Georgia</option>
                <option value="north-carolina">North Carolina</option>
                <option value="puerto-rico">Puerto Rico</option>
                <option value="south-carolina">South Carolina</option>
                <option value="tennessee">Tennessee</option>
            </select>
            
            <input type="text" class="search-box" id="searchBox" placeholder="Search for person...">
            
            <button class="btn" onclick="expandAll()">‚ûï Expand All</button>
            <button class="btn" onclick="collapseAll()">‚ûñ Collapse All</button>
            <button class="btn" onclick="zoomIn()">üîç+ Zoom In</button>
            <button class="btn" onclick="zoomOut()">üîç- Zoom Out</button>
            <button class="btn btn-secondary" onclick="fitToScreen()">‚§¢ Fit to Screen</button>
            <button class="btn btn-secondary" onclick="centerChart()">‚åñ Center</button>
            <button class="btn btn-secondary" onclick="exportChart()">üì∏ Export PNG</button>
            <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button>
        </div>
    </div>
    
    <div id="chart-container"></div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #ed1b2e;"></div>
            <span>Executive</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #fff5f5; border-color: #ed1b2e;"></div>
            <span>Chief/Director</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f8f9fa;"></div>
            <span>Manager/Staff</span>
        </div>
    </div>
    
    <div class="loading">
        <div class="spinner"></div>
        <p>Loading chart...</p>
    </div>
    
    <!-- D3.js and dependencies -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3.1.0/build/d3-org-chart.min.js"></script>
    <script src="complete-org-data.js"></script>
    
    <script>
        let chart;
        let currentData = [];
        let currentRegion = 'all';
        
        // Initialize chart
        function initChart() {
            chart = new d3.OrgChart()
                .container('#chart-container')
                .nodeWidth((d) => 250)
                .nodeHeight((d) => 80)
                .childrenMargin((d) => 40)
                .compactMarginBetween((d) => 15)
                .compactMarginPair((d) => 80)
                .nodeContent((d, i, arr, state) => {
                    const nodeClass = getNodeClass(d.data);
                    let bgColor = '#ffffff';
                    let textColor = '#333333';
                    let borderColor = '#dddddd';
                    
                    if (nodeClass === 'executive') {
                        bgColor = '#ed1b2e';
                        textColor = 'white';
                        borderColor = '#c41230';
                    } else if (nodeClass === 'chief') {
                        bgColor = '#fff5f5';
                        textColor = '#333';
                        borderColor = '#ed1b2e';
                    } else if (nodeClass === 'director') {
                        bgColor = '#f8f9fa';
                        textColor = '#333';
                        borderColor = '#6d6e70';
                    }
                    
                    return `
                        <div style="padding:10px; width:${d.width}px; height:${d.height}px; background:${bgColor}; border-radius:8px; border:2px solid ${borderColor};">
                            <div style="color:${textColor}; font-size:14px; font-weight:600;">
                                ${d.data.name || 'Vacant'}
                            </div>
                            <div style="color:${textColor}; font-size:12px; margin-top:4px; opacity:0.9;">
                                ${d.data.title || 'Position'}
                            </div>
                            ${d.data.location ? 
                                `<div style="color:${textColor}; font-size:11px; margin-top:2px; opacity:0.7;">
                                    üìç ${d.data.location}
                                </div>` : ''
                            }
                        </div>
                    `;
                })
                .nodeUpdate(function(d, i, arr) {
                    const nodeClass = getNodeClass(d.data);
                    
                    d3.select(this)
                        .select('.node-rect')
                        .attr('rx', 5)
                        .attr('ry', 5)
                        .attr('stroke-width', 2)
                        .attr('fill', () => {
                            if (nodeClass === 'executive') return '#ed1b2e';
                            if (nodeClass === 'chief') return '#fff5f5';
                            if (nodeClass === 'director') return '#f8f9fa';
                            return 'white';
                        })
                        .attr('stroke', () => {
                            if (nodeClass === 'executive') return '#c41230';
                            if (nodeClass === 'chief') return '#ed1b2e';
                            return '#ddd';
                        });
                })
                .linkUpdate(function(d, i, arr) {
                    d3.select(this)
                        .attr('stroke', '#aaa')
                        .attr('stroke-width', 1.5);
                })
                .onNodeClick((d) => {
                    console.log(d);
                });
                
            loadData();
        }
        
        // Get node class based on title
        function getNodeClass(data) {
            const title = (data.title || '').toLowerCase();
            if (title.includes('executive') || title.includes('vp') || title.includes('vice president')) {
                return 'executive';
            }
            if (title.includes('chief') || title.includes('director')) {
                return 'chief';
            }
            if (title.includes('manager')) {
                return 'director';
            }
            return 'staff';
        }
        
        // Convert nested data to flat format for d3-org-chart
        function convertToFlatData(data, parentId = null, region = null, idPrefix = '') {
            let result = [];
            let nodeId = 1;
            
            // Helper to create unique IDs
            function createId(prefix, index) {
                return `${prefix}-${index}`;
            }
            
            // Process a single node and its children
            function processNode(node, parentId, currentRegion, path = '') {
                if (!node) return;
                
                const id = createId(path || currentRegion || 'node', nodeId++);
                const nodeData = {
                    id: id,
                    parentId: parentId,
                    name: node.name || 'Vacant',
                    title: node.title || 'Position',
                    location: node.location || '',
                    region: currentRegion
                };
                
                result.push(nodeData);
                
                // Process children if they exist
                if (node.children) {
                    if (Array.isArray(node.children)) {
                        node.children.forEach((child, index) => {
                            processNode(child, id, currentRegion, `${path}-${index}`);
                        });
                    } else if (typeof node.children === 'object') {
                        Object.keys(node.children).forEach((key, index) => {
                            processNode(node.children[key], id, currentRegion, `${path}-${key}`);
                        });
                    }
                }
            }
            
            // Start processing from top level
            if (typeof data === 'object' && !data.name && !data.title) {
                // This is the regions object
                if (currentRegion === 'all') {
                    // Create a root node for all regions
                    const rootId = 'root';
                    result.push({
                        id: rootId,
                        parentId: null,
                        name: 'SE & Caribbean Division',
                        title: 'All Regions',
                        location: '',
                        region: 'all'
                    });
                    
                    // Process each region
                    Object.keys(data).forEach(regionKey => {
                        const regionData = data[regionKey];
                        if (regionData) {
                            const regionId = createId(regionKey, 0);
                            // Add region as a node
                            result.push({
                                id: regionId,
                                parentId: rootId,
                                name: regionKey.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                title: 'Regional Organization',
                                location: '',
                                region: regionKey
                            });
                            // Process region's children
                            processNode(regionData, regionId, regionKey, regionKey);
                        }
                    });
                } else if (data[currentRegion]) {
                    // Process single region
                    processNode(data[currentRegion], null, currentRegion, currentRegion);
                }
            } else {
                // Process as a single node
                processNode(data, parentId, region || 'unknown', idPrefix);
            }
            
            return result;
        }
        
        // Load data
        function loadData() {
            console.log('Loading data...');
            if (typeof completeOrgData !== 'undefined') {
                console.log('Found completeOrgData');
                currentRegion = 'all'; // Start with ALL regions view
                const flatData = convertToFlatData(completeOrgData, null, currentRegion, '');
                currentData = flatData;
                console.log('Loaded data:', currentData.length, 'nodes');
                console.log('Sample data:', currentData.slice(0, 5));
                
                // Update dropdown to match
                document.getElementById('regionSelect').value = currentRegion;
                
                updateChart();
            } else {
                console.error('completeOrgData not found');
                // Try loading it directly
                const script = document.createElement('script');
                script.src = 'complete-org-data.js';
                script.onload = () => {
                    console.log('Script loaded, retrying...');
                    setTimeout(loadData, 100);
                };
                document.head.appendChild(script);
            }
        }
        
        // Update chart with filtered data
        function updateChart() {
            try {
                // Regenerate data for current region selection
                const flatData = convertToFlatData(completeOrgData, null, currentRegion, '');
                currentData = flatData;
                
                console.log(`Updating chart for region: ${currentRegion}, nodes: ${currentData.length}`);
                
                if (chart && currentData.length > 0) {
                    console.log('Rendering chart...');
                    chart.data(currentData).render();
                    setTimeout(() => {
                        chart.fit();
                        console.log('Chart rendered and fitted');
                    }, 500);
                } else {
                    console.error('No chart or no data available');
                }
            } catch (error) {
                console.error('Error updating chart:', error);
                // Show error to user
                document.getElementById('chart-container').innerHTML = 
                    `<div style="padding: 50px; text-align: center;">
                        <h3>Error loading chart</h3>
                        <p>${error.message}</p>
                        <p>Please check console for details.</p>
                    </div>`;
            }
        }
        
        // Control functions
        function expandAll() {
            if (chart) {
                chart.expandAll();
                console.log('Expanded all nodes');
            }
        }
        
        function collapseAll() {
            if (chart) {
                chart.collapseAll();
                console.log('Collapsed all nodes');
            }
        }
        
        function fitToScreen() {
            if (chart) {
                chart.fit();
                console.log('Fitted to screen');
            }
        }
        
        function zoomIn() {
            if (chart) {
                chart.zoomIn();
                console.log('Zoomed in');
            }
        }
        
        function zoomOut() {
            if (chart) {
                chart.zoomOut();
                console.log('Zoomed out');
            }
        }
        
        function centerChart() {
            if (chart) {
                chart.center();
                console.log('Centered chart');
            }
        }
        
        function exportChart() {
            if (chart) {
                chart.exportImg({
                    full: true,
                    save: true,
                    onLoad: (base64) => {
                        const link = document.createElement('a');
                        link.download = `org-chart-${currentRegion}-${Date.now()}.png`;
                        link.href = base64;
                        link.click();
                    }
                });
            }
        }
        
        // Search functionality
        document.getElementById('searchBox').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length > 2) {
                const found = currentData.filter(d => 
                    d.name && d.name.toLowerCase().includes(searchTerm)
                );
                
                if (found.length > 0 && chart) {
                    // Highlight found nodes
                    chart.clearHighlighting();
                    found.forEach(node => {
                        chart.setHighlighted(node.id);
                    });
                    
                    // Center on first result
                    if (found[0]) {
                        chart.setCentered(found[0].id);
                    }
                }
            } else if (chart) {
                chart.clearHighlighting();
            }
        });
        
        // Region selector
        document.getElementById('regionSelect').addEventListener('change', (e) => {
            currentRegion = e.target.value;
            updateChart(); // Update chart for new region
        });
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', initChart);
    </script>
</body>
</html>