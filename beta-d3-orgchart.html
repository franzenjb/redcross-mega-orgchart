<!DOCTYPE html>
<html>
<head>
    <title>Red Cross Org Chart - Beta (D3)</title>
    <meta charset="utf-8">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 24px;
            color: #1a1a1a;
            margin-bottom: 15px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .region-select {
            padding: 8px 15px;
            border: 2px solid #ed1b2e;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #333;
            cursor: pointer;
            min-width: 200px;
        }
        
        .btn {
            padding: 8px 20px;
            background: #ed1b2e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #c41230;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6d6e70;
        }
        
        .btn-secondary:hover {
            background: #5a5b5d;
        }
        
        .search-box {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 250px;
            font-size: 14px;
        }
        
        #chart-container {
            width: 100%;
            height: calc(100vh - 120px);
            min-height: 600px;
            background: white;
            overflow: hidden;
            position: relative;
        }
        
        /* D3 OrgChart Custom Styles */
        .node-rect {
            rx: 5;
            ry: 5;
            fill: white;
            stroke: #ddd;
            stroke-width: 2;
        }
        
        .node-rect-executive {
            fill: #ed1b2e;
            stroke: #c41230;
        }
        
        .node-rect-chief {
            fill: #fff5f5;
            stroke: #ed1b2e;
        }
        
        .node-rect-director {
            fill: #f8f9fa;
            stroke: #6d6e70;
        }
        
        .node-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .node-title {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .node-location {
            font-size: 11px;
            opacity: 0.6;
        }
        
        .link {
            fill: none;
            stroke: #aaa;
            stroke-width: 1.5;
        }
        
        /* Legend */
        .legend {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        
        /* Loading */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ed1b2e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Print Styles */
        @media print {
            /* Hide everything except the chart */
            body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Hide controls and header */
            .header {
                display: none !important;
            }
            
            .legend {
                display: none !important;
            }
            
            .loading {
                display: none !important;
            }
            
            /* Make chart full page */
            #chart-container {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
            }
            
            /* Ensure SVG prints properly */
            svg {
                width: 100% !important;
                height: 100vh !important;
                max-width: none !important;
                overflow: visible !important;
            }
            
            /* D3 OrgChart specific */
            .svg-chart-container {
                background: white !important;
                transform: scale(0.8) !important;
                transform-origin: top center !important;
            }
            
            /* Force all nodes to be visible and styled */
            .node {
                page-break-inside: avoid !important;
            }
            
            .node foreignObject {
                overflow: visible !important;
            }
            
            .node-foreign-object-div {
                background: white !important;
                border: 1px solid #333 !important;
            }
            
            /* Make text readable */
            text, div {
                color: black !important;
                fill: black !important;
                opacity: 1 !important;
                font-size: 10px !important;
            }
            
            /* Ensure connection lines are visible */
            path, .link {
                stroke: #666 !important;
                stroke-width: 1px !important;
                fill: none !important;
                opacity: 1 !important;
            }
            
            /* Node content styling for print */
            [data-node-id] > div {
                background: white !important;
                border: 1px solid #333 !important;
                padding: 5px !important;
            }
            
            /* Print color adjustments */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            @page {
                size: landscape;
                margin: 0.5in;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Menu -->
    <div id="sidebar" style="position: fixed; left: -300px; top: 0; width: 300px; height: 100vh; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.2); z-index: 1000; transition: left 0.3s; display: flex; flex-direction: column;">
        <div style="padding: 20px; border-bottom: 1px solid #ddd; flex-shrink: 0;">
            <h3 style="margin: 0;">🛠️ Tools & Settings</h3>
            <button onclick="toggleSidebar()" style="position: absolute; right: 10px; top: 20px; background: none; border: none; font-size: 24px; cursor: pointer;">✖</button>
        </div>
        
        <div style="padding: 20px; overflow-y: auto; flex: 1;">
            <!-- View Controls -->
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">View Controls</h4>
                <button class="btn" onclick="expandAll()" style="width: 100%; margin-bottom: 5px;">➕ Expand All</button>
                <button class="btn" onclick="collapseAll()" style="width: 100%; margin-bottom: 5px;">➖ Collapse All</button>
                <button class="btn" onclick="fitToScreen()" style="width: 100%; margin-bottom: 5px;">⤢ Fit to Screen</button>
                <button class="btn" onclick="centerChart()" style="width: 100%;">⌖ Center</button>
            </div>
            
            <!-- Export Options -->
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">Export & Print</h4>
                <button class="btn btn-secondary" onclick="exportChart()" style="width: 100%; margin-bottom: 5px;">📸 Export PNG</button>
                <button class="btn btn-secondary" onclick="printPreview()" style="width: 100%; margin-bottom: 5px;">👁️ Print Preview</button>
                <button class="btn btn-secondary" onclick="printChart()" style="width: 100%; margin-bottom: 5px;">🖨️ Print</button>
                <button class="btn" onclick="toggleSelectionMode()" style="background: #e17055; width: 100%; margin-top: 10px;" id="selectionModeBtn">
                    <span id="selectionBtnText">🎯 Select Area (Beta)</span>
                </button>
                <div id="selectionHelp" style="display: none; margin-top: 10px; padding: 10px; background: #fee; border-radius: 5px; font-size: 12px;">
                    Click and drag to select an area to print. Press ESC to cancel.
                </div>
            </div>
            
            <!-- Editing Guide -->
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">✏️ Corrections</h4>
                <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; font-size: 13px;">
                    <p style="margin: 5px 0;"><strong>Double-click:</strong> Fix name/title</p>
                    <p style="margin: 5px 0;"><strong>Right-click:</strong> Edit menu</p>
                    <p style="margin: 5px 0;"><strong>Export JSON:</strong> Save current chart</p>
                    <p style="margin: 5px 0; color: #666;">Corrections save automatically!</p>
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
                    <p style="margin: 5px 0; color: #e74c3c;"><strong>🔒 Admin Only:</strong></p>
                    <p style="margin: 5px 0; color: #999;">• Add/Delete positions</p>
                    <p style="margin: 5px 0; color: #999;">• Structural changes</p>
                </div>
                <details style="margin-top: 10px;">
                    <summary style="cursor: pointer; color: #0984e3;">📝 JSON Editing Tips</summary>
                    <div style="background: #fff; padding: 10px; margin-top: 5px; border-left: 3px solid #0984e3; font-size: 12px;">
                        <p style="margin: 5px 0;">Each person has:</p>
                        <code style="display: block; background: #f5f5f5; padding: 5px; margin: 5px 0;">
{
  "name": "John Doe",
  "title": "Director",
  "location": "Atlanta",
  "children": []
}
                        </code>
                        <p style="margin: 5px 0;">Add people to "children" array</p>
                    </div>
                </details>
            </div>
            
            <!-- Data Management -->
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">Data Management</h4>
                <button class="btn" style="background: #00b894; width: 100%; margin-bottom: 5px;" onclick="saveToLocal()">💾 Save Changes</button>
                <button class="btn" style="background: #0984e3; width: 100%; margin-bottom: 5px;" onclick="exportData()">📤 Export Current Version</button>
                <button class="btn" style="background: #6c5ce7; width: 100%; margin-bottom: 5px;" onclick="importData()">📥 Import JSON</button>
                <button class="btn" style="background: #e74c3c; width: 100%; margin-bottom: 5px;" onclick="openSimpleEditor()">✏️ Simple Editor (NEW)</button>
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
                <button class="btn" style="background: #f39c12; width: 100%; margin-bottom: 5px;" onclick="createBackup()">🔒 Create Backup</button>
                <button class="btn" style="background: #3498db; width: 100%; margin-bottom: 5px;" onclick="showBackups()">📚 View Backups</button>
                <button class="btn" style="background: #fdcb6e; width: 100%;" onclick="resetData()">🔄 Reset to Original</button>
                <div style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 5px; font-size: 12px;">
                    <strong>✅ Protected:</strong> Original data always safe
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Header (Simplified) -->
    <div class="header">
        <button onclick="toggleSidebar()" style="position: absolute; left: 20px; top: 20px; background: #333; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 20px;">☰</button>
        
        <h1 style="text-align: center;">🏥 Red Cross SE & Caribbean Division - Beta Org Chart</h1>
        
        <div class="controls" style="justify-content: center; padding-top: 10px;">
            <select class="region-select" id="regionSelect">
                <option value="division">Division Leadership</option>
                <option value="alabama-mississippi">Alabama/Mississippi</option>
                <option value="florida-nc">Florida N/C</option>
                <option value="florida-south">Florida South</option>
                <option value="georgia">Georgia</option>
                <option value="north-carolina">North Carolina</option>
                <option value="puerto-rico">Puerto Rico</option>
                <option value="south-carolina">South Carolina</option>
                <option value="tennessee">Tennessee</option>
                <option value="all">All Regions</option>
            </select>
            
            <div style="display: flex; align-items: center; gap: 5px;">
                <span style="font-size: 14px; color: #666;">🔍 Search:</span>
                <input type="text" class="search-box" id="searchBox" placeholder="Enter name..." style="width: 200px;">
                <button class="btn" onclick="performSearch()" style="padding: 5px 10px; font-size: 14px;">Search</button>
            </div>
            
            <!-- View Controls in Top Bar -->
            <button class="btn" onclick="fitToScreen()" title="Fit to Screen">⤢ Fit</button>
            <button class="btn" onclick="centerChart()" title="Center">⌖ Center</button>
            <button class="btn" onclick="resetView()" title="Reset View" style="background: #e74c3c;">🔄 Reset</button>
            <button class="btn" onclick="clearCache()" title="Clear Cache" style="background: #e67e22;">🗑️ Clear Cache</button>
            
            <span style="padding: 8px 12px; background: #ffeaa7; border-radius: 4px; font-size: 12px; margin-left: 10px;">
                💡 <strong>Corrections:</strong> Double-click to fix names/titles • <strong>Navigate:</strong> Click to expand/collapse • Scroll to zoom
            </span>
        </div>
        
        <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleFileImport(event)">
    </div>
    
    <div id="chart-container"></div>
    
    <!-- Selection overlay for area printing -->
    <svg id="selectionOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 999;">
        <rect id="selectionRect" fill="rgba(0, 123, 255, 0.2)" stroke="rgba(0, 123, 255, 0.8)" stroke-width="2" stroke-dasharray="5,5" />
    </svg>
    
    <!-- Backup History Modal -->
    <div id="backupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; max-height: 80%; background: white; border-radius: 10px; overflow: hidden;">
            <div style="padding: 20px; background: #2c3e50; color: white;">
                <h3 style="margin: 0;">📚 Backup History</h3>
                <button onclick="closeBackupModal()" style="position: absolute; right: 20px; top: 20px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">✖</button>
            </div>
            <div id="backupList" style="padding: 20px; max-height: 400px; overflow-y: auto;">
                <!-- Backups will be listed here -->
            </div>
            <div style="padding: 15px; background: #ecf0f1; border-top: 1px solid #bdc3c7;">
                <small>💡 Tip: Create backups before major changes. You can always restore from any backup.</small>
            </div>
        </div>
    </div>
    
    <!-- Simple JSON Editor Modal -->
    <div id="simpleEditorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 800px; height: 80%; background: white; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column;">
            <div style="padding: 20px; background: #2c3e50; color: white; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0;">🛠️ Simple Organization Editor</h2>
                <button onclick="closeSimpleEditor()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">✖</button>
            </div>
            
            <div style="padding: 20px; background: #ecf0f1; border-bottom: 1px solid #bdc3c7;">
                <p style="margin: 0; color: #7f8c8d;">📌 Click on any person to edit their details. Changes are saved automatically.</p>
            </div>
            
            <div style="flex: 1; display: flex; overflow: hidden;">
                <!-- Tree View -->
                <div style="flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa;">
                    <div id="editorTreeView"></div>
                </div>
                
                <!-- Edit Form -->
                <div style="width: 350px; padding: 20px; background: white; border-left: 1px solid #ddd; overflow-y: auto;">
                    <h3 style="margin-top: 0;">Edit Person</h3>
                    <div id="editorForm">
                        <p style="color: #999;">← Select a person from the tree to edit</p>
                    </div>
                </div>
            </div>
            
            <div style="padding: 15px; background: #ecf0f1; border-top: 1px solid #bdc3c7; display: flex; justify-content: space-between;">
                <button onclick="addNewPerson()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">➕ Add Person (Admin Only)</button>
                <div>
                    <button onclick="saveEditorChanges()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">💾 Save All Changes</button>
                    <button onclick="closeSimpleEditor()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Legend removed - not needed -->
    
    <div class="loading">
        <div class="spinner"></div>
        <p>Loading chart...</p>
    </div>
    
    <!-- D3.js and dependencies -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3.1.0/build/d3-org-chart.min.js"></script>
    <script src="complete-org-data.js"></script>
    <script src="divisional-leadership.js"></script>
    
    <script>
        let chart;
        let currentData = [];
        let currentRegion = 'all';
        
        // Initialize chart
        function initChart() {
            // Ensure container has dimensions
            const container = document.getElementById('chart-container');
            if (!container) {
                console.error('Chart container not found');
                return;
            }
            
            // Set explicit dimensions if needed
            if (container.offsetWidth === 0 || container.offsetHeight === 0) {
                container.style.width = window.innerWidth + 'px';
                container.style.height = (window.innerHeight - 120) + 'px';
            }
            
            console.log('Container dimensions:', container.offsetWidth, 'x', container.offsetHeight);
            
            chart = new d3.OrgChart()
                .container('#chart-container')
                .svgWidth(container.offsetWidth)
                .svgHeight(container.offsetHeight)
                .nodeWidth((d) => 250)
                .nodeHeight((d) => 80)
                .childrenMargin((d) => 40)
                .compactMarginBetween((d) => 15)
                .compactMarginPair((d) => 80)
                .initialZoom(0.6)
                .nodeContent((d, i, arr, state) => {
                    const nodeClass = getNodeClass(d.data);
                    const regionColor = getRegionColor(d.data);
                    let bgColor = regionColor.bg;
                    let textColor = regionColor.text;
                    let borderColor = regionColor.border;
                    let borderWidth = '2px';
                    
                    // Special cases for division leadership
                    if (nodeClass === 'division-vp') {
                        bgColor = 'linear-gradient(135deg, #ffd700 0%, #ffed4e 100%)';
                        textColor = 'black';
                        borderColor = '#ffa000';
                        borderWidth = '3px';
                    } else if (d.data.name === "Division Executive Staff") {
                        bgColor = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
                        textColor = 'black';
                        borderColor = '#1976d2';
                    }
                    
                    // For executives, make them slightly different
                    if (nodeClass === 'executive' && d.data.region) {
                        // Add a gradient effect for executives
                        const baseColor = regionColor.bg;
                        bgColor = `linear-gradient(135deg, ${baseColor} 0%, ${baseColor}dd 100%)`;
                    }
                    
                    // Add jump button for regional staff
                    const showJumpButton = d.data.region && d.data.region !== 'division' && d.data.region !== 'all' && currentRegion !== d.data.region;
                    
                    return `
                        <div style="padding:10px; width:${d.width}px; height:${d.height}px; background:${bgColor}; border-radius:8px; border:${borderWidth} solid ${borderColor}; position:relative;">
                            ${showJumpButton ? `
                                <div style="position:absolute; top:5px; right:5px;">
                                    <button onclick="jumpToRegion('${d.data.region}', '${d.data.id}')" 
                                            style="background:#4a90e2; color:white; border:none; border-radius:3px; padding:2px 6px; cursor:pointer; font-size:10px; opacity:0.8; hover:opacity:1;"
                                            title="Jump to ${d.data.region} region">
                                        →
                                    </button>
                                </div>
                            ` : ''}
                            <div style="color:${textColor}; font-size:14px; font-weight:600;">
                                ${d.data.name || 'Vacant'}
                            </div>
                            <div style="color:${textColor}; font-size:12px; margin-top:4px; opacity:0.95;">
                                ${d.data.title || 'Position'}
                            </div>
                            ${d.data.location ? 
                                `<div style="color:${textColor}; font-size:11px; margin-top:2px; opacity:0.85;">
                                    📍 ${d.data.location}
                                </div>` : ''
                            }
                        </div>
                    `;
                })
                .nodeUpdate(function(d, i, arr) {
                    const nodeClass = getNodeClass(d.data);
                    
                    d3.select(this)
                        .select('.node-rect')
                        .attr('rx', 5)
                        .attr('ry', 5)
                        .attr('stroke-width', 2)
                        .attr('fill', () => {
                            if (nodeClass === 'executive') return '#ed1b2e';
                            if (nodeClass === 'chief') return '#fff5f5';
                            if (nodeClass === 'director') return '#f8f9fa';
                            return 'white';
                        })
                        .attr('stroke', () => {
                            if (nodeClass === 'executive') return '#c41230';
                            if (nodeClass === 'chief') return '#ed1b2e';
                            return '#ddd';
                        });
                })
                .linkUpdate(function(d, i, arr) {
                    d3.select(this)
                        .attr('stroke', '#aaa')
                        .attr('stroke-width', 1.5);
                })
                .onNodeClick((d) => {
                    // Handle double-click manually
                    if (d.clickTimer) {
                        clearTimeout(d.clickTimer);
                        d.clickTimer = null;
                        // Double click detected
                        editNode(d);
                    } else {
                        // Single click - wait to see if it's a double click
                        d.clickTimer = setTimeout(() => {
                            d.clickTimer = null;
                            console.log('Single clicked - will auto-fit now');
                            
                            // After expansion/collapse, properly fit the view
                            setTimeout(() => {
                                if (chart) {
                                    // Use fit with a smaller zoom level for expanded nodes
                                    const hasExpandedChildren = currentData.some(node => 
                                        node.parentId === d.data.id
                                    );
                                    
                                    if (hasExpandedChildren) {
                                        // If we just expanded, first center on the clicked node
                                        chart.setCentered(d.data.id).render();
                                        console.log('Centered on expanded node:', d.data.name);
                                        
                                        // Then fit to show all children with appropriate zoom
                                        setTimeout(() => {
                                            chart.fit().render();
                                            console.log('Fitted view to show all children');
                                            
                                            // Final center adjustment to ensure clicked node is visible
                                            setTimeout(() => {
                                                chart.setCentered(d.data.id).render();
                                                console.log('Final center on parent:', d.data.name);
                                            }, 300);
                                        }, 300);
                                    } else {
                                        // If we collapsed, center on the node
                                        chart.setCentered(d.data.id).render();
                                        console.log('Centered on collapsed node:', d.data.name);
                                    }
                                }
                            }, 600);
                        }, 250);
                    }
                });
                
            loadData();
        }
        
        // Define region colors
        const regionColors = {
            'alabama-mississippi': { bg: '#8b0000', border: '#5c0000', text: 'white' }, // Dark red
            'florida-nc': { bg: '#00796b', border: '#004d40', text: 'white' }, // Teal
            'florida-south': { bg: '#f57c00', border: '#e65100', text: 'white' }, // Orange
            'georgia': { bg: '#1976d2', border: '#0d47a1', text: 'white' }, // Blue
            'north-carolina': { bg: '#388e3c', border: '#1b5e20', text: 'white' }, // Green
            'puerto-rico': { bg: '#7b1fa2', border: '#4a148c', text: 'white' }, // Purple
            'south-carolina': { bg: '#c2185b', border: '#880e4f', text: 'white' }, // Pink
            'tennessee': { bg: '#5d4037', border: '#3e2723', text: 'white' }, // Brown
            'division': { bg: '#ffd700', border: '#ffa000', text: 'black' }, // Gold for division
            'division-staff': { bg: '#e3f2fd', border: '#1976d2', text: 'black' } // Light blue for division staff
        };
        
        // Detect region from node data
        function detectRegionFromData(node) {
            if (!node) return '';
            
            const title = (node.title || '').toLowerCase();
            const location = (node.location || '').toLowerCase();
            const name = (node.name || '').toLowerCase();
            
            // Check for regional indicators
            if (title.includes('florida n/c') || location.includes('jacksonville') || location.includes('tampa')) {
                return 'florida-nc';
            } else if (title.includes('florida south') || location.includes('miami')) {
                return 'florida-south';
            } else if ((title.includes('georgia') && !title.includes('strait')) || location.includes('atlanta')) {
                return 'georgia';
            } else if (title.includes('tennessee') || location.includes('nashville') || location.includes('memphis')) {
                return 'tennessee';
            } else if (title.includes('alabama') || title.includes('mississippi') || location.includes('birmingham') || location.includes('jackson')) {
                return 'alabama-mississippi';
            } else if ((title.includes('north carolina') && !title.includes('florida')) || location.includes('charlotte')) {
                return 'north-carolina';
            } else if ((title.includes('south carolina') && !title.includes('north')) || location.includes('columbia')) {
                return 'south-carolina';
            } else if (title.includes('puerto rico') || location.includes('san juan')) {
                return 'puerto-rico';
            }
            
            return '';
        }
        
        // Get region color for a node
        function getRegionColor(data) {
            // Check the node's region or type first, then detect from data
            let region = data.region || data.type || detectRegionFromData(data) || '';
            
            // Additional detection based on title/location if still not determined
            if (!region && data.title) {
                const title = data.title.toLowerCase();
                const location = (data.location || '').toLowerCase();
                
                // Check for regional CDOs, SAF Directors, Communications Directors, etc.
                if (title.includes('florida n/c') || location.includes('jacksonville') || location.includes('tampa')) {
                    region = 'florida-nc';
                } else if (title.includes('florida south') || location.includes('miami')) {
                    region = 'florida-south';
                } else if ((title.includes('georgia') && !title.includes('strait')) || location.includes('atlanta')) {
                    region = 'georgia';
                } else if (title.includes('tennessee') || location.includes('nashville') || location.includes('memphis')) {
                    region = 'tennessee';
                } else if (title.includes('alabama') || title.includes('mississippi') || location.includes('birmingham') || location.includes('jackson')) {
                    region = 'alabama-mississippi';
                } else if ((title.includes('north carolina') && !title.includes('florida')) || location.includes('charlotte')) {
                    region = 'north-carolina';
                } else if ((title.includes('south carolina') && !title.includes('north')) || location.includes('columbia')) {
                    region = 'south-carolina';
                } else if (title.includes('puerto rico') || location.includes('san juan')) {
                    region = 'puerto-rico';
                }
            }
            
            return regionColors[region] || { bg: '#ffffff', border: '#cccccc', text: '#333333' };
        }
        
        // Get node class based on title
        function getNodeClass(data) {
            const title = (data.title || '').toLowerCase();
            const type = (data.type || '').toLowerCase();
            
            // Special styling for division nodes
            if (type === 'division') {
                return 'division-vp';
            }
            if (type === 'division-staff') {
                return 'division-staff';
            }
            if (title.includes('executive') || title.includes('vp') || title.includes('vice president')) {
                return 'executive';
            }
            if (title.includes('chief') || title.includes('director')) {
                return 'chief';
            }
            if (title.includes('manager')) {
                return 'director';
            }
            return 'staff';
        }
        
        // Convert nested data to flat format for d3-org-chart
        function convertToFlatData(data, parentId = null, region = null, idPrefix = '') {
            let result = [];
            let nodeId = 1;
            
            // Helper to create unique IDs
            function createId(prefix, index) {
                return `${prefix}-${index}`;
            }
            
            // Process a single node and its children
            function processNode(node, parentId, currentRegion, path = '') {
                if (!node) return;
                
                const id = createId(path || currentRegion || 'node', nodeId++);
                const nodeData = {
                    id: id,
                    parentId: parentId,
                    name: node.name || 'Vacant',
                    title: node.title || 'Position',
                    location: node.location || '',
                    region: node.region || node.type || currentRegion || detectRegionFromData(node),
                    type: node.type || currentRegion
                };
                
                result.push(nodeData);
                
                // Process children if they exist
                if (node.children) {
                    if (Array.isArray(node.children)) {
                        node.children.forEach((child, index) => {
                            // Pass the child's region if it has one, otherwise detect it or use current region
                            const childRegion = child.region || child.type || detectRegionFromData(child) || currentRegion;
                            processNode(child, id, childRegion, `${path}-${index}`);
                        });
                    } else if (typeof node.children === 'object') {
                        Object.keys(node.children).forEach((key, index) => {
                            const childData = node.children[key];
                            const childRegion = childData.region || childData.type || detectRegionFromData(childData) || currentRegion;
                            processNode(childData, id, childRegion, `${path}-${key}`);
                        });
                    }
                }
            }
            
            // Check if data has the new structure with division at the top
            if (data && data.division) {
                // New structure with Anna Trefethen at top
                const divisionNode = data.division;
                
                if (currentRegion === 'all') {
                    // Process entire hierarchy starting with Anna Trefethen
                    processNode(divisionNode, null, 'division', 'division');
                } else if (currentRegion === 'division') {
                    // ALWAYS show Anna Trefethen at the top
                    const annaId = 'division-vp';
                    result.push({
                        id: annaId,
                        parentId: null,
                        name: divisionNode.name || 'Anna Trefethen',
                        title: divisionNode.title || 'Division Vice President',
                        location: divisionNode.location || 'SE & Caribbean Division',
                        region: 'division',
                        type: 'division-vp'
                    });
                    
                    // Load Division Leadership under Anna
                    if (window.divisionalLeadership && window.divisionalLeadership['division-leadership']) {
                        const divLeadershipData = window.divisionalLeadership['division-leadership'];
                        
                        // Add Division Leadership box as a child of Anna
                        const divLeadershipId = 'division-leadership';
                        result.push({
                            id: divLeadershipId,
                            parentId: annaId,
                            name: divLeadershipData.name || 'Division Leadership',
                            title: divLeadershipData.title || 'SE & Caribbean Division',
                            location: divLeadershipData.location || 'Division HQ',
                            region: 'division',
                            type: 'division'
                        });
                        
                        // Process all the division leadership children
                        if (divLeadershipData.children && Array.isArray(divLeadershipData.children)) {
                            divLeadershipData.children.forEach((child, index) => {
                                processNode(child, divLeadershipId, 'division', `division-leadership-${index}`);
                            });
                        }
                    } else {
                        // Fallback: Show division's children under Anna
                        if (divisionNode.children) {
                            divisionNode.children.forEach((child, index) => {
                                processNode(child, annaId, 'division', `division-${index}`);
                            });
                        }
                    }
                } else {
                    // Find the specific region in the children array
                    if (divisionNode.children && Array.isArray(divisionNode.children)) {
                        // Skip the Division Executive Staff node and look in regional executives
                        for (let child of divisionNode.children) {
                            if (child.type === currentRegion) {
                                processNode(child, null, currentRegion, currentRegion);
                                break;
                            }
                        }
                    }
                }
            } else if (typeof data === 'object' && !data.name && !data.title) {
                // Old structure - regions object at top level
                if (currentRegion === 'all') {
                    // Create a root node for all regions
                    const rootId = 'root';
                    result.push({
                        id: rootId,
                        parentId: null,
                        name: 'SE & Caribbean Division',
                        title: 'All Regions',
                        location: '',
                        region: 'all'
                    });
                    
                    // Process each region
                    Object.keys(data).forEach(regionKey => {
                        const regionData = data[regionKey];
                        if (regionData) {
                            const regionId = createId(regionKey, 0);
                            // Add region as a node
                            result.push({
                                id: regionId,
                                parentId: rootId,
                                name: regionKey.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                title: 'Regional Organization',
                                location: '',
                                region: regionKey
                            });
                            // Process region's children
                            processNode(regionData, regionId, regionKey, regionKey);
                        }
                    });
                } else if (data[currentRegion]) {
                    // Process single region
                    processNode(data[currentRegion], null, currentRegion, currentRegion);
                }
            } else {
                // Process as a single node
                processNode(data, parentId, region || 'unknown', idPrefix);
            }
            
            return result;
        }
        
        // Load data
        function loadData() {
            console.log('Loading data...');
            
            // SKIP localStorage to ensure fresh data without Virginia Mewborn
            // const savedData = localStorage.getItem('orgChartData');
            // if (savedData) {
            //     try {
            //         window.completeOrgData = JSON.parse(savedData);
            //         console.log('Using saved data from localStorage');
            //     } catch(e) {
            //         console.log('Failed to parse saved data:', e);
            //     }
            // }
            
            // Clear any old cached data with Virginia Mewborn
            localStorage.removeItem('orgChartData');
            
            // Load divisional leadership data if needed
            if (currentRegion === 'division' && !window.divisionalLeadership) {
                const divScript = document.createElement('script');
                divScript.src = 'divisional-leadership.js';
                divScript.onload = () => {
                    console.log('Divisional Leadership script loaded');
                };
                document.head.appendChild(divScript);
            }
            
            if (typeof completeOrgData !== 'undefined') {
                console.log('Found completeOrgData:', completeOrgData);
                currentRegion = document.getElementById('regionSelect')?.value || 'all';
                const flatData = convertToFlatData(completeOrgData, null, currentRegion, '');
                currentData = flatData;
                console.log('Loaded data:', currentData.length, 'nodes');
                console.log('Sample data:', currentData.slice(0, 5));
                
                // Update dropdown to match
                if (document.getElementById('regionSelect')) {
                    document.getElementById('regionSelect').value = currentRegion;
                }
                
                updateChart();
            } else {
                console.error('completeOrgData not found, loading script...');
                // Try loading it directly
                const script = document.createElement('script');
                script.src = 'complete-org-data.js';
                script.onload = () => {
                    console.log('Script loaded, completeOrgData available:', typeof completeOrgData !== 'undefined');
                    setTimeout(loadData, 100);
                };
                script.onerror = () => {
                    console.error('Failed to load complete-org-data.js');
                };
                document.head.appendChild(script);
            }
        }
        
        // Update chart with filtered data
        function updateChart() {
            try {
                // Regenerate data for current region selection
                const flatData = convertToFlatData(completeOrgData, null, currentRegion, '');
                currentData = flatData;
                
                console.log(`Updating chart for region: ${currentRegion}, nodes: ${currentData.length}`);
                
                if (!chart) {
                    console.error('Chart not initialized');
                    return;
                }
                
                if (currentData.length === 0) {
                    console.error('No data available for region:', currentRegion);
                    return;
                }
                
                // Ensure container still has dimensions
                const container = document.getElementById('chart-container');
                if (container.offsetWidth === 0 || container.offsetHeight === 0) {
                    container.style.width = window.innerWidth + 'px';
                    container.style.height = (window.innerHeight - 120) + 'px';
                }
                
                console.log('Rendering chart...');
                chart
                    .data(currentData)
                    .svgWidth(container.offsetWidth)
                    .svgHeight(container.offsetHeight)
                    .render();
                    
                setTimeout(() => {
                    if (chart && chart.fit) {
                        chart.fit();
                        console.log('Chart rendered and fitted');
                        
                        // Special handling for Division Leadership view to ensure proper fit
                        if (currentRegion === 'division') {
                            setTimeout(() => {
                                // Expand first level to show VPs
                                const rootNode = currentData.find(d => !d.parentId);
                                if (rootNode) {
                                    chart.setExpanded(rootNode.id).render();
                                    setTimeout(() => {
                                        // Center on the root node first
                                        chart.setCentered(rootNode.id).render();
                                        console.log('Centered on Division Leadership root');
                                        
                                        // Then fit to show all expanded content
                                        setTimeout(() => {
                                            chart.fit();
                                            console.log('Division Leadership expanded and fitted');
                                        }, 300);
                                    }, 500);
                                }
                            }, 500);
                        }
                    }
                }, 800);
            } catch (error) {
                console.error('Error updating chart:', error);
                // Show error to user
                document.getElementById('chart-container').innerHTML = 
                    `<div style="padding: 50px; text-align: center;">
                        <h3>Error loading chart</h3>
                        <p>${error.message}</p>
                        <p>Please check console for details.</p>
                    </div>`;
            }
        }
        
        // Track expansion level
        let currentExpansionLevel = 1;
        
        // Control functions
        function expandAll() {
            if (chart && currentData) {
                // Get nodes at the next level to expand
                const nodesToExpand = [];
                
                // Find all currently expanded nodes
                const expandedNodes = new Set();
                currentData.forEach(node => {
                    // Check if node is expanded (has children and they're visible)
                    const nodeElement = chart.getChartState().allNodes?.find(n => n.id === node.id);
                    if (nodeElement && nodeElement._expanded) {
                        expandedNodes.add(node.id);
                    }
                });
                
                // If nothing is expanded, start with root
                if (expandedNodes.size === 0) {
                    const rootNode = currentData.find(d => !d.parentId);
                    if (rootNode) {
                        nodesToExpand.push(rootNode.id);
                    }
                } else {
                    // Find children of expanded nodes to expand next
                    currentData.forEach(node => {
                        if (expandedNodes.has(node.parentId) && !expandedNodes.has(node.id)) {
                            // This node's parent is expanded but this node isn't
                            nodesToExpand.push(node.id);
                        }
                    });
                }
                
                // Expand the next level
                if (nodesToExpand.length > 0) {
                    nodesToExpand.forEach(nodeId => {
                        chart.setExpanded(nodeId);
                    });
                    chart.render();
                    
                    console.log(`Expanded ${nodesToExpand.length} nodes at level ${currentExpansionLevel}`);
                    currentExpansionLevel++;
                    
                    // Auto-fit after expansion
                    setTimeout(() => {
                        chart.fit();
                        console.log('Auto-fitted after expand level');
                    }, 500);
                } else {
                    console.log('All nodes already expanded');
                }
            }
        }
        
        function collapseAll() {
            if (chart) {
                chart.collapseAll();
                currentExpansionLevel = 1; // Reset expansion level
                console.log('Collapsed all nodes');
                // Auto-fit after collapse
                setTimeout(() => {
                    chart.fit();
                    console.log('Auto-fitted after collapse all');
                }, 500);
            }
        }
        
        function fitToScreen() {
            if (chart) {
                // Simple fit that works
                chart.fit();
                console.log('Fitted to screen');
            }
        }
        
        function zoomIn() {
            if (chart) {
                // Use the chart's built-in zoom methods
                const currentZoom = chart.getChartState().initialZoom || 1;
                const newZoom = currentZoom * 1.2;
                chart.initialZoom(newZoom).render();
                console.log('Zoomed in to', newZoom);
            }
        }
        
        function zoomOut() {
            if (chart) {
                // Use the chart's built-in zoom methods
                const currentZoom = chart.getChartState().initialZoom || 1;
                const newZoom = currentZoom * 0.8;
                chart.initialZoom(newZoom).render();
                console.log('Zoomed out to', newZoom);
            }
        }
        
        function centerChart() {
            if (chart) {
                // Center on the root node
                const rootNode = currentData.find(d => !d.parentId);
                if (rootNode) {
                    chart.setCentered(rootNode.id).render();
                    console.log('Centered on root node');
                } else {
                    chart.fit();
                    console.log('Centered chart via fit');
                }
            }
        }
        
        function clearCache() {
            // Clear all localStorage data
            localStorage.removeItem('orgChartData');
            console.log('Cache cleared - reloading fresh data');
            alert('Cache cleared! The page will reload with fresh data.');
            location.reload();
        }
        
        // Jump to a specific region and focus on a person
        function jumpToRegion(regionId, personId) {
            console.log('Jumping to region:', regionId, 'person:', personId);
            
            // Update the dropdown
            const regionSelect = document.getElementById('regionSelect');
            if (regionSelect) {
                // Map region IDs to dropdown values
                const regionMap = {
                    'florida-nc': 'florida-nc',
                    'florida-south': 'florida-south',
                    'georgia': 'georgia',
                    'tennessee': 'tennessee',
                    'alabama-mississippi': 'alabama-mississippi',
                    'north-carolina': 'north-carolina',
                    'south-carolina': 'south-carolina',
                    'puerto-rico': 'puerto-rico'
                };
                
                const mappedRegion = regionMap[regionId] || regionId;
                regionSelect.value = mappedRegion;
                
                // Trigger change event
                const event = new Event('change');
                regionSelect.dispatchEvent(event);
                
                // After region loads, find and center on the person
                setTimeout(() => {
                    // Find the person in the new data and center on them
                    const targetNode = currentData.find(n => 
                        n.name === personId || 
                        n.id === personId ||
                        (n.name && personId && n.name.toLowerCase().includes(personId.toLowerCase()))
                    );
                    
                    if (targetNode && chart) {
                        // Expand path to this node
                        let nodeToExpand = targetNode;
                        const nodesToExpand = [];
                        
                        // Find all parent nodes
                        while (nodeToExpand.parentId) {
                            const parent = currentData.find(n => n.id === nodeToExpand.parentId);
                            if (parent) {
                                nodesToExpand.unshift(parent.id);
                                nodeToExpand = parent;
                            } else {
                                break;
                            }
                        }
                        
                        // Expand all parents
                        nodesToExpand.forEach(nodeId => {
                            chart.setExpanded(nodeId);
                        });
                        
                        // Center on target
                        chart.setCentered(targetNode.id).render();
                        
                        // Highlight the node briefly
                        setTimeout(() => {
                            chart.fit();
                            console.log('Centered on', targetNode.name, 'in', regionId);
                        }, 500);
                    }
                }, 1000);
            }
        }
        
        // Make jumpToRegion available globally
        window.jumpToRegion = jumpToRegion;
        
        function resetView() {
            if (chart) {
                // Reset zoom to initial
                chart.initialZoom(0.7).render();
                
                // Collapse all nodes
                chart.collapseAll();
                
                // Expand just the first two levels
                setTimeout(() => {
                    const rootNode = currentData.find(d => !d.parentId);
                    if (rootNode) {
                        chart.setExpanded(rootNode.id);
                        // Expand first level children
                        currentData
                            .filter(d => d.parentId === rootNode.id)
                            .forEach(node => chart.setExpanded(node.id));
                    }
                    chart.render().fit();
                    console.log('View reset to default');
                }, 300);
            }
        }
        
        function exportChart() {
            if (chart) {
                chart.exportImg({
                    full: true,
                    save: true,
                    onLoad: (base64) => {
                        const link = document.createElement('a');
                        link.download = `org-chart-${currentRegion}-${Date.now()}.png`;
                        link.href = base64;
                        link.click();
                    }
                });
            }
        }
        
        function printChart() {
            // Print exactly what's currently visible
            if (chart) {
                // Just print as-is, no changes
                window.print();
            } else {
                window.print();
            }
        }
        
        function printPreview() {
            if (chart) {
                // Create a preview window
                const previewWindow = window.open('', 'Print Preview', 'width=1200,height=800');
                
                // Clone the current document structure
                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Print Preview - Red Cross Org Chart</title>
                        <style>
                            ${document.querySelector('style').innerHTML}
                            
                            /* Preview specific styles */
                            body {
                                margin: 0;
                                padding: 20px;
                                background: white;
                            }
                            .header, .legend, .loading {
                                display: none !important;
                            }
                            #chart-container {
                                width: 100%;
                                height: 100vh;
                                background: white;
                            }
                            .preview-header {
                                position: fixed;
                                top: 0;
                                left: 0;
                                right: 0;
                                background: #f8f9fa;
                                padding: 10px 20px;
                                border-bottom: 2px solid #dee2e6;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                z-index: 1000;
                            }
                            .preview-title {
                                font-size: 18px;
                                font-weight: bold;
                                color: #333;
                            }
                            .preview-buttons {
                                display: flex;
                                gap: 10px;
                            }
                            .preview-btn {
                                padding: 8px 16px;
                                background: #007bff;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                            }
                            .preview-btn:hover {
                                background: #0056b3;
                            }
                            .preview-btn.cancel {
                                background: #6c757d;
                            }
                            .preview-btn.cancel:hover {
                                background: #5a6268;
                            }
                            #preview-container {
                                margin-top: 60px;
                                width: 100%;
                                height: calc(100vh - 60px);
                                overflow: auto;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="preview-header">
                            <div class="preview-title">🖨️ Print Preview - Current View</div>
                            <div class="preview-buttons">
                                <button class="preview-btn" onclick="window.print()">🖨️ Print</button>
                                <button class="preview-btn cancel" onclick="window.close()">✖️ Close</button>
                            </div>
                        </div>
                        <div id="preview-container">
                            ${document.getElementById('chart-container').innerHTML}
                        </div>
                    </body>
                    </html>
                `;
                
                previewWindow.document.open();
                previewWindow.document.write(htmlContent);
                previewWindow.document.close();
            }
        }
        
        // Function to show search results dropdown
        function showSearchResults(matches, searchTerm) {
            // Remove existing dropdown if any
            const existingDropdown = document.getElementById('searchResultsDropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }
            
            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.id = 'searchResultsDropdown';
            dropdown.style.cssText = `
                position: absolute;
                top: 60px;
                left: 400px;
                background: white;
                border: 2px solid #007bff;
                border-radius: 4px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                max-height: 300px;
                overflow-y: auto;
                z-index: 1000;
                min-width: 350px;
            `;
            
            // Add header
            const header = document.createElement('div');
            header.style.cssText = `
                padding: 10px;
                background: #007bff;
                color: white;
                font-weight: bold;
                border-bottom: 1px solid #ddd;
            `;
            header.textContent = `Found ${matches.length} matches for "${searchTerm}"`;
            dropdown.appendChild(header);
            
            // Add results
            matches.forEach((person, index) => {
                const item = document.createElement('div');
                item.style.cssText = `
                    padding: 10px;
                    cursor: pointer;
                    border-bottom: 1px solid #eee;
                    transition: background 0.2s;
                `;
                item.innerHTML = `
                    <strong>${person.name}</strong><br>
                    <small style="color: #666;">${person.title}</small>
                    ${person.location ? '<br><small style="color: #999;">📍 ' + person.location + '</small>' : ''}
                `;
                
                item.addEventListener('mouseenter', () => {
                    item.style.background = '#f0f8ff';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.background = 'white';
                });
                item.addEventListener('click', () => {
                    // Navigate to this person
                    navigateToNode(person);
                    dropdown.remove();
                    document.getElementById('searchBox').value = person.name;
                });
                
                dropdown.appendChild(item);
            });
            
            document.body.appendChild(dropdown);
            
            // Close dropdown on click outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target.id !== 'searchBox') {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }
        
        // Function to navigate to a specific node
        function navigateToNode(node) {
            // First check if we need to switch regions
            // If the node isn't in current data, switch to "All Regions" view
            if (!currentData.find(d => d.id === node.id)) {
                console.log('Node not in current view, switching to All Regions');
                document.getElementById('regionSelect').value = 'all';
                currentRegion = 'all';
                updateChart();
                
                // Wait for chart update then navigate
                setTimeout(() => {
                    navigateToNodeInternal(node);
                }, 800);
            } else {
                navigateToNodeInternal(node);
            }
        }
        
        function navigateToNodeInternal(node) {
            if (!chart) return;
            
            // Build the path from root to the found node
            const buildPath = (nodeId) => {
                const path = [];
                let current = currentData.find(d => d.id === nodeId);
                while (current) {
                    path.unshift(current.id);
                    if (current.parentId) {
                        current = currentData.find(d => d.id === current.parentId);
                    } else {
                        break;
                    }
                }
                return path;
            };
            
            const pathToNode = buildPath(node.id);
            
            // Expand all nodes in the path
            pathToNode.forEach(nodeId => {
                chart.setExpanded(nodeId);
            });
            
            // Wait for expansion to complete
            setTimeout(() => {
                // Highlight found node
                chart.clearHighlighting();
                chart.setHighlighted(node.id);
                
                // First render the expansion
                chart.render();
                
                // Then center directly on the found node
                setTimeout(() => {
                    console.log(`Centering on found node: ${node.name}`);
                    chart.setCentered(node.id).render();
                    
                    // Zoom in slightly for better visibility
                    setTimeout(() => {
                        chart.initialZoom(2.0).render();
                        
                        // Final re-center to ensure node is in view
                        setTimeout(() => {
                            chart.setCentered(node.id).render();
                            console.log(`Final center on: ${node.name}`);
                        }, 300);
                    }, 300);
                }, 400);
            }, 600);
        }
        
        // Search function that can be called by button or Enter key
        function performSearch() {
            const searchBox = document.getElementById('searchBox');
            const searchTerm = searchBox.value.trim();
            
            if (searchTerm.length === 0) {
                return;
            }
            
            // Search across ALL data, not just current view
            // First create a complete data set from all regions
            let allData = [];
            
            // Always include the top-level VP if available
            if (window.completeOrgData) {
                // MANUALLY add Anna Trefethen first since she's the top VP
                if (window.completeOrgData.division) {
                    allData.push({
                        id: 'division-vp',
                        parentId: null,
                        name: window.completeOrgData.division.name || 'Anna Trefethen',
                        title: window.completeOrgData.division.title || 'Division Vice President',
                        location: window.completeOrgData.division.location || 'SE & Caribbean Division',
                        region: 'division'
                    });
                }
                
                // Get data from all regions  
                const allRegionsData = convertToFlatData(completeOrgData, null, 'all', '');
                allData = allData.concat(allRegionsData);
                
                // Also search in current view data in case it has different entries
                if (currentData && currentData.length > 0) {
                    currentData.forEach(node => {
                        // Add if not already in allData
                        if (!allData.find(n => n.id === node.id)) {
                            allData.push(node);
                        }
                    });
                }
            } else {
                // If no complete data available, fall back to current data
                allData = currentData;
            }
            
            // Case-insensitive search with partial matching
            const searchLower = searchTerm.toLowerCase();
            const found = allData.filter(d => 
                d.name && d.name.toLowerCase().includes(searchLower)
            );
            
            if (found.length > 0) {
                console.log(`Found ${found.length} matches for "${searchTerm}":`);
                found.forEach(p => console.log(`  - ${p.name} (${p.title}) ${p.location || ''}`));
                
                // ALWAYS show dropdown for user to select, even with single match
                showSearchResults(found, searchTerm);
            } else {
                alert(`No matches found for "${searchTerm}"`);
            }
        }
        
        // Search functionality - works on Enter key
        document.getElementById('searchBox').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
        
        // Clear dropdown when search box is cleared
        document.getElementById('searchBox').addEventListener('input', (e) => {
            if (e.target.value.trim() === '') {
                const dropdown = document.getElementById('searchResultsDropdown');
                if (dropdown) dropdown.remove();
            }
        });
        
        // Region selector
        document.getElementById('regionSelect').addEventListener('change', (e) => {
            currentRegion = e.target.value;
            
            // Load divisional leadership if needed
            if (currentRegion === 'division' && !window.divisionalLeadership) {
                const divScript = document.createElement('script');
                divScript.src = 'divisional-leadership.js';
                divScript.onload = () => {
                    console.log('Divisional Leadership script loaded');
                    updateChart();
                };
                document.head.appendChild(divScript);
            } else {
                updateChart(); // Update chart for new region
            }
        });
        
        // Toggle sidebar function
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const currentLeft = sidebar.style.left;
            sidebar.style.left = currentLeft === '0px' ? '-300px' : '0px';
        }
        
        // Selection mode variables
        let selectionMode = false;
        let selectionStart = null;
        let selectionEnd = null;
        
        // Toggle selection mode
        function toggleSelectionMode() {
            selectionMode = !selectionMode;
            const btn = document.getElementById('selectionModeBtn');
            const btnText = document.getElementById('selectionBtnText');
            const help = document.getElementById('selectionHelp');
            const overlay = document.getElementById('selectionOverlay');
            const container = document.getElementById('chart-container');
            
            if (selectionMode) {
                btn.style.background = '#00b894';
                btnText.textContent = '✓ Selection Mode Active';
                help.style.display = 'block';
                overlay.style.display = 'block';
                overlay.style.pointerEvents = 'auto';
                container.style.cursor = 'crosshair';
                
                // Add mouse event listeners
                overlay.addEventListener('mousedown', startSelection);
                overlay.addEventListener('mousemove', updateSelection);
                overlay.addEventListener('mouseup', endSelection);
                
                // ESC key to cancel
                document.addEventListener('keydown', handleSelectionEscape);
            } else {
                btn.style.background = '#e17055';
                btnText.textContent = '🎯 Select Area (Beta)';
                help.style.display = 'none';
                overlay.style.display = 'none';
                overlay.style.pointerEvents = 'none';
                container.style.cursor = 'default';
                
                // Remove event listeners
                overlay.removeEventListener('mousedown', startSelection);
                overlay.removeEventListener('mousemove', updateSelection);
                overlay.removeEventListener('mouseup', endSelection);
                document.removeEventListener('keydown', handleSelectionEscape);
                
                // Clear selection
                clearSelection();
            }
        }
        
        function startSelection(e) {
            if (!selectionMode) return;
            selectionStart = { x: e.clientX, y: e.clientY };
            selectionEnd = null;
        }
        
        function updateSelection(e) {
            if (!selectionMode || !selectionStart) return;
            
            const rect = document.getElementById('selectionRect');
            const x = Math.min(selectionStart.x, e.clientX);
            const y = Math.min(selectionStart.y, e.clientY);
            const width = Math.abs(e.clientX - selectionStart.x);
            const height = Math.abs(e.clientY - selectionStart.y);
            
            rect.setAttribute('x', x);
            rect.setAttribute('y', y);
            rect.setAttribute('width', width);
            rect.setAttribute('height', height);
        }
        
        function endSelection(e) {
            if (!selectionMode || !selectionStart) return;
            
            selectionEnd = { x: e.clientX, y: e.clientY };
            
            // Calculate selected area
            const x1 = Math.min(selectionStart.x, selectionEnd.x);
            const y1 = Math.min(selectionStart.y, selectionEnd.y);
            const x2 = Math.max(selectionStart.x, selectionEnd.x);
            const y2 = Math.max(selectionStart.y, selectionEnd.y);
            
            // Find nodes within selection
            const selectedNodes = findNodesInSelection(x1, y1, x2, y2);
            
            if (selectedNodes.length > 0) {
                printSelectedArea(selectedNodes);
            } else {
                alert('No nodes selected. Please try again.');
            }
            
            // Exit selection mode
            toggleSelectionMode();
        }
        
        function clearSelection() {
            const rect = document.getElementById('selectionRect');
            rect.setAttribute('x', 0);
            rect.setAttribute('y', 0);
            rect.setAttribute('width', 0);
            rect.setAttribute('height', 0);
            selectionStart = null;
            selectionEnd = null;
        }
        
        function handleSelectionEscape(e) {
            if (e.key === 'Escape' && selectionMode) {
                toggleSelectionMode();
            }
        }
        
        function findNodesInSelection(x1, y1, x2, y2) {
            const selectedNodes = [];
            const container = document.getElementById('chart-container');
            const containerRect = container.getBoundingClientRect();
            
            // Adjust coordinates relative to container
            x1 -= containerRect.left;
            y1 -= containerRect.top;
            x2 -= containerRect.left;
            y2 -= containerRect.top;
            
            // Try multiple selectors to find nodes
            let nodes = container.querySelectorAll('.node-rect-cls-0');
            if (nodes.length === 0) {
                // Try alternative selectors used by d3-org-chart
                nodes = container.querySelectorAll('rect[class*="node"]');
            }
            if (nodes.length === 0) {
                // Try getting all rect elements within g elements
                nodes = container.querySelectorAll('g rect');
            }
            
            console.log(`Found ${nodes.length} node elements to check`);
            
            nodes.forEach(node => {
                const rect = node.getBoundingClientRect();
                const nodeX = rect.left - containerRect.left + rect.width / 2;
                const nodeY = rect.top - containerRect.top + rect.height / 2;
                
                // Check if node center is within selection
                if (nodeX >= x1 && nodeX <= x2 && nodeY >= y1 && nodeY <= y2) {
                    // Try to get node data from parent g element
                    const gElement = node.closest('g');
                    if (gElement) {
                        const nodeData = d3.select(gElement).datum();
                        if (nodeData && nodeData.data) {
                            selectedNodes.push(nodeData);
                            console.log('Selected node:', nodeData.data.name);
                        }
                    }
                }
            });
            
            console.log(`Selected ${selectedNodes.length} nodes in total`);
            return selectedNodes;
        }
        
        function printSelectedArea(nodes) {
            console.log(`Printing ${nodes.length} selected nodes:`, nodes);
            
            // Create a temporary container for selected nodes
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Selected Area - Red Cross Org Chart</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        h1 { color: #ed1b2e; }
                        .node { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
                        .node-name { font-weight: bold; }
                        .node-title { color: #666; }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Red Cross SE & Caribbean Division - Selected Area</h1>
                    <p>Selected ${nodes.length} positions:</p>
                    ${nodes.map(n => `
                        <div class="node">
                            <div class="node-name">${n.data.name || 'Unknown'}</div>
                            <div class="node-title">${n.data.title || ''}</div>
                            <div class="node-location">${n.data.location || ''}</div>
                        </div>
                    `).join('')}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Trigger print dialog
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing chart...');
            
            // Load saved data if exists
            loadFromLocal();
            
            // Initialize chart immediately
            initChart();
            
            // Add context menu for right-click
            addContextMenu();
        });
        
        // Edit node function
        function editNode(node) {
            const currentNode = currentData.find(d => d.id === node.data.id);
            if (!currentNode) return;
            
            const form = document.createElement('div');
            form.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000;">
                    <h3 style="margin-bottom: 15px;">Edit Employee</h3>
                    <input type="text" id="edit-name" placeholder="Name" value="${currentNode.name || ''}" 
                           style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="text" id="edit-title" placeholder="Title" value="${currentNode.title || ''}"
                           style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="text" id="edit-location" placeholder="Location" value="${currentNode.location || ''}"
                           style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="display: flex; gap: 10px;">
                        <button onclick="saveNodeEdit('${node.data.id}')" 
                                style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Save
                        </button>
                        <button onclick="closeEditForm()" 
                                style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="deleteNode('${node.data.id}')" 
                                style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Delete
                        </button>
                    </div>
                </div>
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;"
                     onclick="closeEditForm()"></div>
            `;
            form.id = 'edit-form';
            document.body.appendChild(form);
            document.getElementById('edit-name').focus();
        }
        
        function saveNodeEdit(nodeId) {
            const node = currentData.find(d => d.id === nodeId);
            if (node) {
                node.name = document.getElementById('edit-name').value;
                node.title = document.getElementById('edit-title').value;
                node.location = document.getElementById('edit-location').value;
                
                updateChart();
                saveToLocal();
                closeEditForm();
            }
        }
        
        function closeEditForm() {
            const form = document.getElementById('edit-form');
            if (form) form.remove();
        }
        
        function deleteNode(nodeId) {
            if (confirm('Are you sure you want to delete this employee and all their reports?')) {
                // Remove node and update parent's children
                currentData = currentData.filter(d => d.id !== nodeId);
                
                // Remove as child from parent
                currentData.forEach(node => {
                    if (node.children) {
                        node.children = node.children.filter(child => child.id !== nodeId);
                    }
                });
                
                updateChart();
                saveToLocal();
                closeEditForm();
            }
        }
        
        function addNode(parentId) {
            const parent = currentData.find(d => d.id === parentId);
            if (!parent) return;
            
            const newNode = {
                id: 'node-' + Date.now(),
                parentId: parentId,
                name: 'New Employee',
                title: 'Position',
                location: parent.location || '',
                region: parent.region
            };
            
            currentData.push(newNode);
            updateChart();
            saveToLocal();
            
            // Edit the new node immediately
            setTimeout(() => {
                const d3Node = { data: newNode };
                editNode(d3Node);
            }, 500);
        }
        
        // Save/Load functions
        function saveToLocal() {
            localStorage.setItem('orgChartData', JSON.stringify(completeOrgData));
            localStorage.setItem('orgChartFlat', JSON.stringify(currentData));
            
            // Show save confirmation
            const msg = document.createElement('div');
            msg.innerHTML = '✅ Changes saved locally!';
            msg.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #28a745; color: white; padding: 10px 20px; border-radius: 4px; z-index: 10000;';
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 2000);
        }
        
        function loadFromLocal() {
            const saved = localStorage.getItem('orgChartData');
            if (saved) {
                try {
                    completeOrgData = JSON.parse(saved);
                    console.log('Loaded saved data from local storage');
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }
        
        function exportData() {
            const dataStr = JSON.stringify(completeOrgData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `org-chart-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }
        
        function importData() {
            document.getElementById('importFile').click();
        }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        completeOrgData = JSON.parse(e.target.result);
                        loadData();
                        saveToLocal();
                        alert('Data imported successfully!');
                    } catch (err) {
                        alert('Error importing file: ' + err.message);
                    }
                };
                reader.readAsText(file);
            }
        }
        
        function resetData() {
            if (confirm('Reset to original data? All changes will be lost!')) {
                localStorage.removeItem('orgChartData');
                localStorage.removeItem('orgChartFlat');
                location.reload();
            }
        }
        
        // Context menu for right-click
        function addContextMenu() {
            document.addEventListener('contextmenu', (e) => {
                // Check if right-clicked on a node - look for d3 org chart node elements
                const nodeElement = e.target.closest('.node-rect-cls-0') || 
                                   e.target.closest('g[data-id]') || 
                                   e.target.closest('.node');
                
                if (nodeElement) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Try to get node data from D3
                    let nodeData = null;
                    let nodeId = null;
                    
                    // Try different ways to get the node data
                    const gElement = nodeElement.closest('g[data-id]');
                    if (gElement) {
                        nodeId = gElement.getAttribute('data-id');
                        nodeData = currentData.find(d => d.id === nodeId);
                    } else {
                        // Try to get from D3 datum
                        const d3Node = d3.select(nodeElement.closest('g'));
                        if (d3Node && d3Node.datum()) {
                            nodeData = d3Node.datum();
                            nodeId = nodeData.data ? nodeData.data.id : nodeData.id;
                        }
                    }
                    
                    if (!nodeId && nodeData) {
                        nodeId = nodeData.id || (nodeData.data && nodeData.data.id);
                    }
                    
                    if (!nodeId) {
                        console.log('Could not find node ID for context menu');
                        return;
                    }
                    
                    // Remove existing menu
                    const existing = document.getElementById('context-menu');
                    if (existing) existing.remove();
                    
                    const menu = document.createElement('div');
                    menu.id = 'context-menu';
                    menu.innerHTML = `
                        <div style="position: fixed; left: ${e.pageX}px; top: ${e.pageY}px; 
                             background: white; border: 1px solid #ddd; border-radius: 4px; 
                             box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10000;">
                            <div onclick="editNodeById('${nodeId}')" style="padding: 8px 16px; cursor: pointer; hover: background: #f0f0f0;">
                                ✏️ Edit Name/Title
                            </div>
                            <div style="padding: 8px 16px; color: #999; font-size: 12px; border-top: 1px solid #eee;">
                                Add/Delete requires admin access
                            </div>
                        </div>
                    `;
                    document.body.appendChild(menu);
                    
                    // Remove menu on click elsewhere
                    setTimeout(() => {
                        document.addEventListener('click', function removeMenu() {
                            menu.remove();
                            document.removeEventListener('click', removeMenu);
                        });
                    }, 100);
                }
            });
        }
        
        function editNodeById(nodeId) {
            const node = currentData.find(d => d.id === nodeId);
            if (node) {
                editNode({ data: node });
            }
        }
        
        // Simple Editor Functions
        let editorData = null;
        let selectedEditorNode = null;
        
        function openSimpleEditor() {
            // Get current data structure
            editorData = JSON.parse(JSON.stringify(currentData)); // Deep clone
            document.getElementById('simpleEditorModal').style.display = 'block';
            renderEditorTree();
        }
        
        function closeSimpleEditor() {
            document.getElementById('simpleEditorModal').style.display = 'none';
            selectedEditorNode = null;
        }
        
        function renderEditorTree() {
            const treeView = document.getElementById('editorTreeView');
            
            // Build hierarchical structure from flat data
            const hierarchy = buildHierarchy(editorData);
            
            // Render as expandable tree
            treeView.innerHTML = renderTreeNode(hierarchy);
        }
        
        function buildHierarchy(flatData) {
            const map = {};
            const roots = [];
            
            // Create map of all nodes
            flatData.forEach(node => {
                map[node.id] = { ...node, children: [] };
            });
            
            // Build tree structure
            flatData.forEach(node => {
                if (node.parentId && map[node.parentId]) {
                    map[node.parentId].children.push(map[node.id]);
                } else if (!node.parentId) {
                    roots.push(map[node.id]);
                }
            });
            
            return roots;
        }
        
        function renderTreeNode(nodes, level = 0) {
            if (!nodes || nodes.length === 0) return '';
            
            let html = '<ul style="list-style: none; padding-left: ' + (level * 20) + 'px;">';
            
            nodes.forEach(node => {
                const hasChildren = node.children && node.children.length > 0;
                html += `
                    <li style="margin: 5px 0;">
                        <div onclick="selectEditorNode('${node.id}')" 
                             style="cursor: pointer; padding: 8px; border-radius: 5px; background: ${selectedEditorNode === node.id ? '#3498db' : '#fff'}; 
                                    color: ${selectedEditorNode === node.id ? 'white' : 'black'}; border: 1px solid #ddd; margin-bottom: 5px;">
                            ${hasChildren ? '▼' : '•'} <strong>${node.name || 'Unnamed'}</strong>
                            <br><small style="color: ${selectedEditorNode === node.id ? '#ecf0f1' : '#7f8c8d'};">${node.title || 'No title'}</small>
                        </div>
                        ${hasChildren ? renderTreeNode(node.children, level + 1) : ''}
                    </li>
                `;
            });
            
            html += '</ul>';
            return html;
        }
        
        function selectEditorNode(nodeId) {
            selectedEditorNode = nodeId;
            renderEditorTree(); // Re-render to show selection
            
            // Show edit form for selected node
            const node = editorData.find(n => n.id === nodeId);
            if (node) {
                showEditorForm(node);
            }
        }
        
        function showEditorForm(node) {
            const form = document.getElementById('editorForm');
            form.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Name:</label>
                    <input type="text" id="editor-name" value="${node.name || ''}" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                           onchange="updateEditorNode('name', this.value)">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Title:</label>
                    <input type="text" id="editor-title" value="${node.title || ''}" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                           onchange="updateEditorNode('title', this.value)">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Location:</label>
                    <input type="text" id="editor-location" value="${node.location || ''}" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                           onchange="updateEditorNode('location', this.value)" disabled>
                    <small style="color: #999;">Location editing requires admin access</small>
                </div>
                <div style="padding: 15px; background: #fff3cd; border-radius: 5px; margin-top: 20px;">
                    <small style="color: #856404;">💡 Tip: Changes are saved in memory. Click "Save All Changes" when done.</small>
                </div>
            `;
        }
        
        function updateEditorNode(field, value) {
            const node = editorData.find(n => n.id === selectedEditorNode);
            if (node) {
                node[field] = value;
                renderEditorTree(); // Re-render tree with updated name
            }
        }
        
        function saveEditorChanges() {
            // Apply editor changes to main data
            currentData = JSON.parse(JSON.stringify(editorData));
            
            // Update the chart
            updateChart();
            
            // Save to localStorage
            saveToLocal();
            
            alert('Changes saved successfully!');
            closeSimpleEditor();
        }
        
        function addNewPerson() {
            alert('Adding new people requires admin access. Please contact your administrator.');
        }
        
        // Backup and History Functions
        function createBackup() {
            const timestamp = new Date().toISOString();
            const backupName = prompt('Name this backup (optional):', `Backup ${new Date().toLocaleDateString()}`);
            
            if (backupName !== null) {
                const backups = JSON.parse(localStorage.getItem('orgChartBackups') || '[]');
                
                backups.push({
                    name: backupName || 'Unnamed Backup',
                    date: timestamp,
                    data: JSON.stringify(currentData)
                });
                
                // Keep only last 10 backups
                if (backups.length > 10) {
                    backups.shift();
                }
                
                localStorage.setItem('orgChartBackups', JSON.stringify(backups));
                alert(`Backup "${backupName}" created successfully!`);
            }
        }
        
        function showBackups() {
            const backups = JSON.parse(localStorage.getItem('orgChartBackups') || '[]');
            const backupList = document.getElementById('backupList');
            
            if (backups.length === 0) {
                backupList.innerHTML = '<p style="text-align: center; color: #999;">No backups found. Create your first backup to protect your work!</p>';
            } else {
                let html = '<div style="max-height: 400px; overflow-y: auto;">';
                
                // Always show original as first option
                html += `
                    <div style="padding: 15px; margin-bottom: 10px; border: 2px solid #27ae60; border-radius: 5px; background: #d4edda;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #155724;">🏛️ Original Data</strong>
                                <br><small style="color: #666;">Factory default - always available</small>
                            </div>
                            <button onclick="resetData(); closeBackupModal();" 
                                    style="padding: 5px 15px; background: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                Restore Original
                            </button>
                        </div>
                    </div>
                `;
                
                // Show user backups
                backups.reverse().forEach((backup, index) => {
                    const date = new Date(backup.date);
                    html += `
                        <div style="padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${backup.name}</strong>
                                    <br><small style="color: #666;">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</small>
                                </div>
                                <div>
                                    <button onclick="restoreBackup(${backups.length - 1 - index})" 
                                            style="padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">
                                        Restore
                                    </button>
                                    <button onclick="deleteBackup(${backups.length - 1 - index})" 
                                            style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                backupList.innerHTML = html;
            }
            
            document.getElementById('backupModal').style.display = 'block';
        }
        
        function closeBackupModal() {
            document.getElementById('backupModal').style.display = 'none';
        }
        
        function restoreBackup(index) {
            if (confirm('Are you sure you want to restore this backup? Current changes will be lost.')) {
                const backups = JSON.parse(localStorage.getItem('orgChartBackups') || '[]');
                if (backups[index]) {
                    currentData = JSON.parse(backups[index].data);
                    updateChart();
                    saveToLocal();
                    closeBackupModal();
                    alert('Backup restored successfully!');
                }
            }
        }
        
        function deleteBackup(index) {
            if (confirm('Are you sure you want to delete this backup?')) {
                const backups = JSON.parse(localStorage.getItem('orgChartBackups') || '[]');
                backups.splice(index, 1);
                localStorage.setItem('orgChartBackups', JSON.stringify(backups));
                showBackups(); // Refresh the list
            }
        }
    </script>
</body>
</html>